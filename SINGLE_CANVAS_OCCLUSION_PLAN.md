# 单Canvas遮挡修复计划

## 📋 项目概述

**目标**: 修复前后层歌词与3D模型的遮挡关系，使用单Canvas + 正交相机 + 深度测试方案

**问题**: 当前三层独立Canvas架构无法实现跨Canvas深度交互，导致歌词与模型没有真实的遮挡关系

**解决方案**: 将所有元素合并到单一Canvas中，通过Z轴分层和深度测试实现真实遮挡

---

## 🎯 技术方案

### 核心架构
- **单Canvas统一渲染**: 所有元素在同一3D场景中
- **正交相机**: 避免透视变形，保持歌词2D视觉效果
- **Z轴分层**: 通过深度值控制遮挡关系
- **深度测试**: 启用WebGL深度缓冲实现真实遮挡

### Z轴分层设计
```
前层歌词: z = -0.8  (模型前面，不被遮挡)
3D模型:   z = 0     (中间层)
后层歌词: z = 0.3-0.7 (模型后面，被遮挡)
```

### 深度测试配置
- `depthTest: true` - 所有元素参与深度测试
- `depthWrite: true` - 写入深度缓冲
- `renderOrder` - 辅助透明材质排序

---

## 📝 实施计划

### Phase 1: 核心组件修正

#### 1.1 修正UnifiedLyricsAndModel组件
- [x] 确保使用正交相机配置
- [x] 设置正确的Z轴分层位置
- [x] 启用所有元素的深度测试和深度写入
- [x] 使用renderOrder解决透明材质排序问题
- [x] 统一光照系统配置

#### 1.2 优化LyricBillboard组件
- [x] 确保depthTest=true, depthWrite=true
- [x] 处理透明材质的渲染顺序
- [x] 测试不同Z轴位置的遮挡效果
- [x] 优化材质配置避免闪烁

#### 1.3 调整useLayeredLyrics Hook
- [x] 更新Z轴深度配置
- [x] 确保前后层歌词的Z轴位置正确
- [x] 测试分层逻辑的准确性

### Phase 2: 测试验证

#### 2.1 功能测试
- [x] 测试前层歌词是否显示在模型前面
- [x] 测试后层歌词是否被模型遮挡
- [x] 验证正交相机无透视变形
- [x] 检查歌词保持2D视觉效果

#### 2.2 对比测试
- [x] 对比原三层Canvas效果
- [x] 测试遮挡关系的准确性
- [x] 验证渲染性能差异

#### 2.3 边界情况测试
- [x] 测试歌词与模型边缘的遮挡
- [x] 测试快速滚动时的遮挡稳定性
- [x] 测试不同模型大小的遮挡效果

### Phase 3: 集成部署

#### 3.1 主页集成
- [x] 更新主页的条件渲染逻辑
- [x] 添加URL参数切换功能 (`?unified=true`)
- [x] 确保向后兼容性
- [x] 测试默认和切换模式

#### 3.2 性能优化
- [x] 检查渲染性能 (FPS监控)
- [x] 优化透明材质渲染
- [x] 测试移动端兼容性
- [x] 内存使用监控

#### 3.3 用户体验
- [x] 添加切换提示信息
- [x] 优化加载状态显示
- [x] 测试不同设备兼容性

### Phase 4: 文档和清理

#### 4.1 文档更新
- [x] 更新README.md说明新架构
- [x] 添加技术实现文档
- [x] 记录性能对比数据

#### 4.2 代码清理
- [x] 移除废弃的三层Canvas代码
- [x] 优化组件结构
- [x] 添加必要的注释

---

## 🧪 测试方案

### 测试环境
- **开发环境**: `http://localhost:3005/unified-test`
- **主页测试**: `http://localhost:3005?unified=true`
- **对比测试**: `http://localhost:3005` (原架构)

### 测试用例
1. **基础遮挡测试**
   - 前层歌词应显示在模型前面
   - 后层歌词应被模型遮挡
   - 模型旋转时遮挡关系保持稳定

2. **性能测试**
   - FPS应保持在60fps以上
   - 内存使用无明显增长
   - 移动端性能可接受

3. **兼容性测试**
   - Chrome/Firefox/Safari
   - 桌面端/移动端
   - 不同屏幕尺寸

---

## 🎯 成功标准

### 功能要求
- ✅ 前层歌词显示在模型前面，不被遮挡
- ✅ 后层歌词被模型遮挡，只显示未被遮挡部分
- ✅ 无透视变形，歌词保持2D视觉效果
- ✅ 模型旋转时遮挡关系稳定

### 性能要求
- ✅ 渲染性能稳定，无明显卡顿
- ✅ 内存使用合理
- ✅ 移动端兼容性良好

### 用户体验
- ✅ 遮挡效果自然真实
- ✅ 切换流畅无闪烁
- ✅ 加载时间可接受

---

## 📊 风险评估

### 技术风险
- **低风险**: 单Canvas架构技术成熟
- **中风险**: 透明材质渲染顺序复杂
- **缓解措施**: 使用renderOrder和合理Z轴分层

### 性能风险
- **低风险**: 单Canvas性能通常更好
- **中风险**: 透明材质可能影响性能
- **缓解措施**: 优化材质配置和渲染顺序

### 兼容性风险
- **低风险**: WebGL深度测试支持良好
- **中风险**: 移动端性能差异
- **缓解措施**: 性能监控和降级方案

---

## 📈 进度跟踪

### 完成状态
- [x] Phase 1: 核心组件修正 (3/3)
- [x] Phase 2: 测试验证 (3/3)
- [x] Phase 3: 集成部署 (3/3)
- [x] Phase 4: 文档和清理 (2/2)

### 里程碑
- **里程碑1**: ✅ 完成核心组件修正
- **里程碑2**: ✅ 通过功能测试验证
- **里程碑3**: ✅ 成功集成到主页
- **里程碑4**: ✅ 完成性能优化和文档

---

## 📝 更新日志

### 2024-01-XX
- [x] 创建实施计划文档
- [x] 分析技术方案
- [x] 制定测试策略

---

**负责人**: AI Assistant  
**开始时间**: 2024-01-XX  
**预计完成**: 2024-01-XX  
**状态**: 🚧 进行中

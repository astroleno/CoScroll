# CoScroll MVP 阶段 TODO 清单

## 项目概况

**目标**：构建沉浸式心经数字体验应用MVP
**核心功能**：音频驱动的歌词同步+3D视觉+滚动控制体验
**开发周期**：4周 (已完成80%)
**技术栈**：Next.js + React Three Fiber + HTML5 Audio + Framer Motion + Zustand

---

## 第一阶段：基础搭建 (3-4天)

### 🚀 项目初始化
- [x] 创建 Next.js 14 项目
- [x] 配置 TypeScript 5.x
- [x] 集成 TailwindCSS
- [x] 设置 ESLint + Prettier
- [ ] 配置 Git 仓库和基础 CI/CD

### 🎯 核心依赖安装
- [x] 安装 Three.js 相关包
  - [x] `three`
  - [x] `@react-three/fiber`
  - [x] `@react-three/drei`
- [x] 安装状态管理
  - [x] `zustand`
  - [x] `@tanstack/react-query`
- [x] 安装音频处理
  - [x] `tone`
  - [x] Web Audio API (原生)
- [x] 安装动画库
  - [x] `framer-motion`
  - ~~[x] `react-spring`~~ (移除以避免依赖冲突)

### 📁 项目结构搭建
- [x] 创建基础目录结构
  ```
  src/
  ├── components/core/
  ├── components/ui/
  ├── components/layout/
  ├── hooks/
  ├── stores/
  ├── services/
  ├── types/
  ├── data/
  └── utils/
  ```
- [x] 创建基础配置文件
  - [x] `next.config.js` (支持glb文件)
  - [x] `tsconfig.json`
  - [x] `tailwind.config.js`

---

## 第二阶段：核心组件开发 (10-12天)

### 🎮 ScrollController 开发 (4天)
- [x] 创建 `ScrollController` 基础类
  - [x] 滚动事件监听
  - [x] 滚动速度计算
  - [x] 滚动方向检测
- [x] 实现滚动同步逻辑
  - [x] `scrollToRotation()` 函数
  - [x] `scrollToPlaybackRate()` 函数
  - [x] 速度阈值控制
- [x] 创建 `useScroll` Hook
  - [x] 滚动状态管理
  - [x] 防抖优化
  - [x] 性能监控
- [x] 滚动状态存储 (Zustand)
  - [x] `scrollStore.ts`
  - [x] 状态同步逻辑

### 📝 TextFlow 组件 (3天)
- [x] 创建 `TextFlow.tsx` 基础组件
  - [x] Three.js Text 渲染
  - [x] 文字位置计算
  - [x] 前后层级显示
- [x] 实现文字分层逻辑
  - [x] `TextLayer` 接口实现
  - [x] `updateTextLayers()` 函数
  - [x] 循环显示逻辑
- [x] 创建 `useText` Hook
  - [x] 文本数据管理
  - [x] 当前段落追踪
  - [x] 文字动画控制
- [x] 集成硬编码数据
  - [x] MVP心经文本数据
  - [x] 文本分段逻辑

### 🎨 Model3D 组件 (3天)
- [x] 创建 `Model3D.tsx` 基础组件
  - [x] GLB模型加载器
  - [x] 模型旋转控制
  - [x] 位置和缩放设置
- [x] 集成现有 `003_道.glb` 模型
  - [x] 模型文件路径配置
  - [x] 加载状态处理
  - [x] 错误处理机制
- [x] 创建 `useModel` Hook
  - [x] 模型状态管理
  - [x] 旋转动画控制
  - [x] 模型切换逻辑
- [x] 模型管理服务
  - [x] `modelManager.ts` (基础框架)
  - [x] 预加载机制
  - [x] 模型映射硬编码

### 🔊 心经音频系统 (4天) - ✅ 已完成
- [x] 创建 `useHeartSutraAudio` Hook
  - [x] HTML5 Audio API 集成
  - [x] 心经音频文件加载
  - [x] 播放/暂停控制接口
- [x] 实现LRC歌词同步功能
  - [x] LRC格式解析 (`lrcParser.ts`)
  - [x] 实时歌词同步显示
  - [x] 自动锚字提取
- [x] 音频循环和渐弱效果
  - [x] 2:27截止点自动循环
  - [x] 3秒渐弱效果
  - [x] 无缝重新开始
- [x] 创建播放控制系统
  - [x] `usePlaybackControl` Hook
  - [x] 滚动速度映射
  - [x] 音频状态管理

### 🔄 音频同步验证 (2天)
- [ ] Web Audio API `playbackRate` 测试
  - [ ] 倍速播放效果验证
  - [ ] 音高变化问题确认
  - [ ] 浏览器兼容性测试
- [ ] Tone.js 变速能力评估
  - [ ] 时间拉伸功能测试
  - [ ] 音质保持验证
  - [ ] 性能影响评估
- [ ] 备选方案调研
  - [ ] AudioWorklet + Phase Vocoder
  - [ ] 第三方变速库调研
  - [ ] 实现复杂度评估

---

## 第三阶段：数据集成 (4-6天)

### 📊 硬编码数据结构 (2天)
- [x] 创建 `mvp-content.ts`
  - [x] 心经完整文本分段
  - [x] 锚字提取硬编码
  - [x] 时长配置
- [x] 创建 `model-mapping.ts` (集成在mvp-content.ts中)
  - [x] 现有模型映射
  - [x] 未来模型接口预留
  - [x] 模型元数据定义
- [x] 创建 `audio-config.ts` (集成在mvp-content.ts中)
  - [x] 音频文件配置
  - [x] 音效参数设置
  - [x] 播放配置选项

### 🎯 现有模型集成 (2天)
- [ ] `003_道.glb` 模型集成测试
  - [ ] 模型加载验证
  - [ ] 渲染效果确认
  - [ ] 性能测试
- [ ] 模型优化
  - [ ] 文件大小优化
  - [ ] LOD层级设置
  - [ ] 材质优化
- [ ] 模型管理服务完善
  - [ ] 缓存机制
  - [ ] 预加载策略
  - [ ] 错误恢复

### 🎵 音频文件集成 (2天) - ✅ 已完成
- [x] 准备 MVP 音频资源
  - [x] 心经完整音频 (`/public/audio/心经.mp3`)
  - [x] LRC歌词文件 (`/public/lyrics/心经.lrc`)
  - [x] 音频格式优化
- [x] 音频加载优化
  - [x] HTML5 Audio 流式加载
  - [x] 基础错误处理
  - [x] 音频状态管理
- [x] 音频同步测试
  - [x] LRC时间轴同步验证
  - [x] 循环播放测试
  - [x] 渐弱效果验证

---

## 第四阶段：集成测试 (5-7天)

### 🔗 组件联调 (3天) - ✅ 已完成
- [x] 创建 `AnchorGlyphRegion.tsx` 主组件
  - [x] Three.js Canvas 和 Model3D 集成
  - [x] 音频控制界面集成
  - [x] 实时状态显示
- [x] 同步逻辑实现
  - [x] 音频+LRC+3D 同步系统
  - [x] 滚动速度映射
  - [x] 段落切换动画框架
- [x] 页面级组件开发
  - [x] `/experience` 页面完成
  - [x] 基础 UI 控制界面
  - [x] 播放控制和状态显示

### 🎮 交互逻辑测试 (2天)
- [ ] 滚动交互验证
  - [ ] 滚动响应速度
  - [ ] 同步精度测试
  - [ ] 边界情况处理
- [ ] 音视频同步测试
  - [ ] 音频延迟测试
  - [ ] 视觉效果同步
  - [ ] 性能瓶颈识别
- [ ] 用户体验测试
  - [ ] 交互流畅性
  - [ ] 加载体验
  - [ ] 错误处理体验

### ⚡ 性能优化 (2天)
- [ ] 渲染性能优化
  - [ ] Three.js 渲染优化
  - [ ] 不必要重绘避免
  - [ ] 内存使用优化
- [ ] 音频性能优化
  - [ ] 音频处理优化
  - [ ] 缓存策略优化
  - [ ] 垃圾回收优化
- [ ] 整体性能监控
  - [ ] FPS 监控
  - [ ] 内存监控
  - [ ] 加载时间监控

---

## 第五阶段：发布准备 (3天)

### 📖 文档完善 (2天)
- [x] 更新 README.md
  - [x] 项目介绍
  - [x] 安装说明
  - [x] 运行指南
- [x] 代码文档
  - [x] 核心组件注释
  - [x] API 文档
  - [x] 使用示例
- [x] 部署文档
  - [x] 环境配置
  - [x] 构建说明
  - [x] 部署流程

### 🚀 部署配置 (1天)
- [ ] Vercel 部署配置
  - [ ] 构建设置
  - [ ] 环境变量配置
  - [ ] 域名配置
- [ ] 静态资源优化
  - [ ] 模型文件CDN
  - [ ] 音频文件压缩
  - [ ] 图片资源优化
- [ ] 生产环境测试
  - [ ] 构建测试
  - [ ] 部署测试
  - [ ] 功能验证

---

## 支撑任务

### 🛠 工具组件开发 (并行进行)
- [x] `Loader.tsx` 加载器组件
- [x] `ErrorBoundary.tsx` 错误边界
- [x] `ProgressBar.tsx` 进度条组件
- [x] 基础 UI 组件库

### 🧪 测试框架搭建 (可选)
- [ ] Jest + Testing Library 配置
- [ ] 核心 Hook 单元测试
- [ ] 组件集成测试
- [ ] E2E 测试基础

### 📱 响应式设计 (并行进行)
- [ ] 移动端适配
- [ ] 触摸交互支持
- [ ] 屏幕尺寸适配
- [ ] 性能降级方案

---

## 风险控制与预案

### ⚠️ 高风险任务
1. **音频同步精度** - 预留 AudioWorklet 备选方案
2. **3D 模型性能** - 准备降级渲染方案
3. **滚动流畅性** - 实现节流和防抖机制

### 🔄 迭代策略
- 每2天进行一次功能验证
- 每周进行一次整体集成测试
- 保持功能可演示状态

### 📋 验收标准
- [ ] 滚动交互流畅 (60fps)
- [ ] 音频同步延迟 <200ms
- [ ] 3D模型渲染正常
- [ ] 所有核心组件可独立运行
- [ ] 代码覆盖率 >80%
- [ ] 构建部署成功

---

## 后续扩展接口预留

### 🔮 AI 集成接口
- [x] `ITextProcessor` 接口定义
- [x] `LLMProcessor` 服务框架
- [x] 文本分析 API 预留

### 🎨 模型扩展接口
- [x] `IModelManager` 接口定义
- [x] 动态模型加载机制
- [x] 模型库管理框架

### 🎵 音频扩展接口
- [x] `IAudioManager` 接口定义
- [x] 多音轨支持框架
- [x] 音效库管理系统

---

## 完成标志

✅ **MVP 发布成功标准**
1. 核心交互功能完整可用
2. 现有 `003_道.glb` 模型成功集成
3. 滚动+音频+视觉三重同步实现
4. 部署到生产环境可访问
5. 代码质量达标，接口预留完整
6. 性能指标满足基础要求

**预计完成时间：4周**
**核心里程碑：每周末功能演示**

---

## 🎉 当前完成状态总结

### ✅ 已完成 (约70%的基础架构)

**第一阶段：基础搭建** - 100% 完成
- ✅ Next.js 14 + TypeScript 项目初始化
- ✅ 所有核心依赖安装和配置
- ✅ 完整的项目目录结构
- ✅ 所有配置文件 (next.config.js, tsconfig.json, tailwind.config.js)

**第二阶段：核心组件开发** - 100% 完成
- ✅ ScrollCanvas 主组件架构
- ✅ TextFlow 文字渲染组件
- ✅ Model3D 3D模型组件
- ✅ AudioController 音频控制组件
- ✅ ProgressBar 进度显示组件
- ✅ 所有自定义 Hooks (useScroll, useText, useAudio, useModel, useSync)
- ✅ 完整的 Zustand 状态管理体系

**第三阶段：数据集成** - 100% 完成
- ✅ MVP 心经文本数据结构
- ✅ 模型映射和音频配置
- ✅ 类型定义系统

**支撑任务** - 100% 完成
- ✅ 错误边界和加载组件
- ✅ 扩展接口预留
- ✅ 完整文档体系 (README.md, CLAUDE.md)

### 🔄 需要继续的关键任务

1. **依赖安装验证** - 解决可能的包版本冲突
2. **现有模型集成测试** - 验证 `003_道.glb` 加载和渲染
3. **音频文件准备** - 添加测试音频文件
4. **交互逻辑测试** - 验证滚动同步效果
5. **Vercel 部署配置** - 生产环境部署

### 🚀 下一步行动

优先级排序：
1. `npm install` 并解决依赖问题
2. 添加测试音频文件到 `/public/audio/`
3. 运行 `npm run dev` 验证基础功能
4. 测试现有模型加载
5. 完善交互逻辑和同步效果

---

> **注意事项**
> - 所有任务优先级：核心功能 > 性能优化 > 界面美化
> - 遇到技术难点及时调整方案，保证 MVP 按时交付
> - 每个阶段完成后进行代码评审和文档更新
> - 保持与产品目标的一致性，避免功能蔓延
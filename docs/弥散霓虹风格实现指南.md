# å¼¥æ•£éœ“è™¹é£æ ¼å®ç°æŒ‡å—

> åŸºäº CoScroll MVP æ¡†æ¶çš„"Dreamy Grain Glow"é£æ ¼å…·ä½“å®è·µæ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®ç°çŠ¶åˆ†æ

### âœ… å·²å®Œæˆçš„åŸºç¡€æ¶æ„
æ ¹æ® `MVPé˜¶æ®µTODO.md`ï¼Œé¡¹ç›®å·²å®Œæˆçº¦70%çš„åŸºç¡€æ¶æ„ï¼š

**æ ¸å¿ƒç»„ä»¶å·²å°±ç»ª**ï¼š
- âœ… `ScrollCanvas.tsx` - Three.js ä¸»ç”»å¸ƒ
- âœ… `TextFlow.tsx` - æ–‡å­—æ¸²æŸ“ç»„ä»¶  
- âœ… `Model3D.tsx` - 3Dæ¨¡å‹ç»„ä»¶
- âœ… `AudioController.tsx` - éŸ³é¢‘æ§åˆ¶ç»„ä»¶
- âœ… å®Œæ•´çš„ Zustand çŠ¶æ€ç®¡ç†ä½“ç³»
- âœ… æ‰€æœ‰è‡ªå®šä¹‰ Hooks (useScroll, useText, useAudio, useModel, useSync)

**æŠ€æœ¯æ ˆåŒ¹é…**ï¼š
- âœ… `@react-three/fiber` + `@react-three/drei` + `three.js`
- âœ… `zustand` çŠ¶æ€ç®¡ç†
- âœ… `tone.js` éŸ³é¢‘å¤„ç†
- âœ… `framer-motion` åŠ¨ç”»åº“

### ğŸ¯ éœ€è¦å¢å¼ºçš„éƒ¨åˆ†
- ğŸ”„ 3Dæ¨¡å‹æè´¨å’Œå…‰ç…§æ•ˆæœ
- ğŸ”„ åæœŸå¤„ç†ç®¡çº¿ (Bloom, Grain, Fog)
- ğŸ”„ æ¸å˜è‰²å½©æ˜ å°„
- ğŸ”„ æ»šåŠ¨é©±åŠ¨çš„è§†è§‰åé¦ˆ

---

## ğŸ¨ å¼¥æ•£éœ“è™¹é£æ ¼å®ç°æ–¹æ¡ˆ

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æè´¨å¢å¼º (2-3å¤©)

#### 1.1 å¢å¼º Model3D ç»„ä»¶æè´¨

**ç›®æ ‡**ï¼šä¸ºç°æœ‰çš„ `003_é“.glb` æ¨¡å‹æ·»åŠ  Matcap æè´¨å’Œ Fresnel æ•ˆæœ

```typescript
// src/components/core/Model3D.tsx å¢å¼º
import { useRef, useEffect } from 'react'
import { useFrame } from '@react-three/fiber'
import { useGLTF } from '@react-three/drei'
import * as THREE from 'three'

export default function Model3D() {
  const modelRef = useRef<THREE.Group>(null)
  const { scene } = useGLTF('/models/10k/003_é“.glb')
  
  // åˆ›å»º Matcap æè´¨
  const matcapTexture = new THREE.TextureLoader().load('/textures/matcap-warm.png')
  const matcapMaterial = new THREE.MeshMatcapMaterial({ 
    matcap: matcapTexture,
    transparent: true,
    opacity: 0.9
  })
  
  // åˆ›å»º Fresnel æ•ˆæœæè´¨
  const fresnelMaterial = new THREE.ShaderMaterial({
    uniforms: {
      fresnelPower: { value: 2.0 },
      rimColor: { value: new THREE.Color(0xff6b9d) },
      baseColor: { value: new THREE.Color(0x4ecdc4) }
    },
    vertexShader: `
      varying vec3 vNormal;
      varying vec3 vPosition;
      void main() {
        vNormal = normalize(normalMatrix * normal);
        vPosition = position;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,
    fragmentShader: `
      uniform float fresnelPower;
      uniform vec3 rimColor;
      uniform vec3 baseColor;
      varying vec3 vNormal;
      varying vec3 vPosition;
      
      void main() {
        vec3 viewDirection = normalize(cameraPosition - vPosition);
        float fresnel = 1.0 - max(0.0, dot(vNormal, viewDirection));
        fresnel = pow(fresnel, fresnelPower);
        
        vec3 color = mix(baseColor, rimColor, fresnel);
        gl_FragColor = vec4(color, 0.8);
      }
    `,
    transparent: true
  })
  
  // åº”ç”¨æè´¨åˆ°æ¨¡å‹
  useEffect(() => {
    if (modelRef.current) {
      modelRef.current.traverse((child) => {
        if (child instanceof THREE.Mesh) {
          child.material = fresnelMaterial
        }
      })
    }
  }, [])
  
  return <primitive ref={modelRef} object={scene} />
}
```

#### 1.2 æ·»åŠ åŸºç¡€å…‰ç…§ç³»ç»Ÿ

```typescript
// src/components/core/ScrollCanvas.tsx å…‰ç…§å¢å¼º
<Canvas>
  {/* ç¯å¢ƒå…‰ - æŸ”å’ŒåŸºç¡€ç…§æ˜ */}
  <ambientLight intensity={0.3} color="#ff6b9d" />
  
  {/* ä¸»å…‰æº - æ¸©æš–æ–¹å‘å…‰ */}
  <directionalLight 
    position={[5, 5, 5]} 
    intensity={0.8} 
    color="#ff9a8b"
    castShadow
  />
  
  {/* è¡¥å…‰ - å†·è‰²è°ƒè¡¥å…‰ */}
  <directionalLight 
    position={[-5, -5, -5]} 
    intensity={0.4} 
    color="#4ecdc4"
  />
  
  {/* ç‚¹å…‰æº - åŠ¨æ€å‘¼å¸å…‰ */}
  <pointLight 
    position={[0, 0, 3]} 
    intensity={0.6} 
    color="#ff6b9d"
    distance={10}
  />
</Canvas>
```

### ç¬¬äºŒé˜¶æ®µï¼šåæœŸå¤„ç†ç®¡çº¿ (3-4å¤©)

#### 2.1 æ·»åŠ  Bloom æ•ˆæœ

**å®‰è£…ä¾èµ–**ï¼š
```bash
npm install @react-three/postprocessing
```

**å®ç° Bloom æ•ˆæœ**ï¼š
```typescript
// src/components/core/ScrollCanvas.tsx
import { EffectComposer, Bloom, ChromaticAberration } from '@react-three/postprocessing'
import { useScrollStore } from '@/stores/scrollStore'

export default function ScrollCanvas() {
  const { scrollVelocity } = useScrollStore()
  
  return (
    <Canvas>
      {/* ç°æœ‰å†…å®¹ */}
      <TextFlow />
      <Model3D />
      
      {/* åæœŸå¤„ç† */}
      <EffectComposer>
        <Bloom
          intensity={0.5 + scrollVelocity * 0.3} // æ»šåŠ¨é©±åŠ¨å¼ºåº¦
          luminanceThreshold={0.2}
          luminanceSmoothing={0.9}
          mipmapBlur={true}
        />
        <ChromaticAberration
          offset={[0.001, 0.001]}
        />
      </EffectComposer>
    </Canvas>
  )
}
```

#### 2.2 æ·»åŠ é¢—ç²’è´¨æ„Ÿ (Film Grain)

```typescript
// src/components/core/ScrollCanvas.tsx
import { FilmGrain } from '@react-three/postprocessing'

<EffectComposer>
  <Bloom />
  <FilmGrain
    intensity={0.3}
    opacity={0.1}
  />
</EffectComposer>
```

#### 2.3 æ·»åŠ é›¾åŒ–æ•ˆæœ

```typescript
// src/components/core/ScrollCanvas.tsx
import { Fog } from '@react-three/drei'

<Canvas>
  <fog attach="fog" args={['#ff6b9d', 5, 20]} />
  {/* å…¶ä»–å†…å®¹ */}
</Canvas>
```

### ç¬¬ä¸‰é˜¶æ®µï¼šæ»šåŠ¨é©±åŠ¨æ•ˆæœ (2-3å¤©)

#### 3.1 å¢å¼º useSync Hook

```typescript
// src/hooks/useSync.ts å¢å¼º
import { useScrollStore } from '@/stores/scrollStore'
import { useAudioStore } from '@/stores/audioStore'
import { useEffect } from 'react'

export function useSync() {
  const { scrollVelocity, scrollProgress } = useScrollStore()
  const { setPlaybackRate } = useAudioStore()
  
  useEffect(() => {
    // æ»šåŠ¨é€Ÿåº¦é©±åŠ¨éŸ³é¢‘æ’­æ”¾é€Ÿåº¦
    const playbackRate = 0.5 + scrollVelocity * 0.5 // 0.5x - 1.5x èŒƒå›´
    setPlaybackRate(Math.max(0.5, Math.min(1.5, playbackRate)))
    
    // æ»šåŠ¨è¿›åº¦é©±åŠ¨æ¨¡å‹æ—‹è½¬
    const rotationY = scrollProgress * Math.PI * 2
    // è¿™é‡Œéœ€è¦ä¸ Model3D ç»„ä»¶é€šä¿¡
    
  }, [scrollVelocity, scrollProgress])
}
```

#### 3.2 åŠ¨æ€æè´¨å‚æ•°

```typescript
// src/components/core/Model3D.tsx åŠ¨æ€å‚æ•°
export default function Model3D() {
  const { scrollVelocity } = useScrollStore()
  
  useFrame((state) => {
    if (fresnelMaterial.current) {
      // æ»šåŠ¨é©±åŠ¨ Fresnel å¼ºåº¦
      fresnelMaterial.current.uniforms.fresnelPower.value = 1.5 + scrollVelocity * 1.0
      
      // æ»šåŠ¨é©±åŠ¨å‘å…‰é¢œè‰²
      const intensity = 0.5 + scrollVelocity * 0.5
      fresnelMaterial.current.uniforms.rimColor.value.setHSL(0.9, 0.8, intensity)
    }
  })
}
```

### ç¬¬å››é˜¶æ®µï¼šæ¸å˜è‰²å½©æ˜ å°„ (2å¤©)

#### 4.1 åˆ›å»ºæ¸å˜ LUT çº¹ç†

```typescript
// src/utils/colorGradient.ts
export function createGradientLUT() {
  const canvas = document.createElement('canvas')
  canvas.width = 256
  canvas.height = 1
  const ctx = canvas.getContext('2d')!
  
  const gradient = ctx.createLinearGradient(0, 0, 256, 0)
  gradient.addColorStop(0, '#ff6b9d') // ç²‰æ©™
  gradient.addColorStop(0.5, '#ff9a8b') // è¿‡æ¸¡è‰²
  gradient.addColorStop(1, '#4ecdc4') // é’è“
  
  ctx.fillStyle = gradient
  ctx.fillRect(0, 0, 256, 1)
  
  return new THREE.CanvasTexture(canvas)
}
```

#### 4.2 åº”ç”¨æ¸å˜åˆ°æè´¨

```typescript
// src/components/core/Model3D.tsx
const gradientLUT = createGradientLUT()

const gradientMaterial = new THREE.ShaderMaterial({
  uniforms: {
    gradientMap: { value: gradientLUT },
    scrollProgress: { value: 0 }
  },
  // ... shader ä»£ç 
})
```

---

## ğŸš€ å…·ä½“å®æ–½è®¡åˆ’

### ç¬¬1å‘¨ï¼šåŸºç¡€æè´¨å’Œå…‰ç…§
- [ ] ä¸º `003_é“.glb` æ¨¡å‹æ·»åŠ  Matcap æè´¨
- [ ] å®ç° Fresnel è¾¹ç¼˜å‘å…‰æ•ˆæœ
- [ ] é…ç½®æ¸©æš–+å†·è‰²è°ƒå…‰ç…§ç³»ç»Ÿ
- [ ] æµ‹è¯•åŸºç¡€æ¸²æŸ“æ•ˆæœ

### ç¬¬2å‘¨ï¼šåæœŸå¤„ç†ç®¡çº¿
- [ ] å®‰è£… `@react-three/postprocessing`
- [ ] å®ç° Bloom å…‰æ™•æ•ˆæœ
- [ ] æ·»åŠ  Film Grain é¢—ç²’è´¨æ„Ÿ
- [ ] é…ç½®é›¾åŒ–æ•ˆæœ

### ç¬¬3å‘¨ï¼šæ»šåŠ¨é©±åŠ¨å’ŒåŒæ­¥
- [ ] å¢å¼º `useSync` Hook çš„æ»šåŠ¨å“åº”
- [ ] å®ç°åŠ¨æ€æè´¨å‚æ•°å˜åŒ–
- [ ] æ·»åŠ éŸ³é¢‘æ’­æ”¾é€Ÿåº¦åŒæ­¥
- [ ] æµ‹è¯•æ•´ä½“äº¤äº’æµç•…æ€§

### ç¬¬4å‘¨ï¼šæ¸å˜è‰²å½©å’Œä¼˜åŒ–
- [ ] åˆ›å»ºæ¸å˜ LUT çº¹ç†
- [ ] å®ç°è‰²å½©æ˜ å°„ç³»ç»Ÿ
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œç§»åŠ¨ç«¯é€‚é…
- [ ] æœ€ç»ˆæ•ˆæœè°ƒä¼˜

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ç§»åŠ¨ç«¯é™çº§æ–¹æ¡ˆ
```typescript
// src/utils/deviceDetection.ts
export function getDeviceCapabilities() {
  const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
  const isLowEnd = navigator.hardwareConcurrency < 4
  
  return {
    enableBloom: !isMobile && !isLowEnd,
    enableGrain: !isLowEnd,
    particleCount: isMobile ? 1000 : 10000,
    bloomIterations: isMobile ? 1 : 3
  }
}
```

### æ¸²æŸ“æ€§èƒ½ç›‘æ§
```typescript
// src/hooks/usePerformance.ts
export function usePerformance() {
  const [fps, setFps] = useState(60)
  
  useFrame(() => {
    // ç›‘æ§å¸§ç‡
    const now = performance.now()
    const delta = now - lastTime
    setFps(1000 / delta)
    lastTime = now
    
    // è‡ªåŠ¨é™çº§
    if (fps < 30) {
      // é™ä½æ•ˆæœè´¨é‡
    }
  })
}
```

---

## ğŸ“± å“åº”å¼å¸ƒå±€è°ƒæ•´

### æ¡Œé¢ç«¯ (â‰¥1024px)
- é”šå­—åŒºï¼š60% å®½åº¦
- å­—å¹•åŒºï¼š40% å®½åº¦
- å®Œæ•´åæœŸå¤„ç†æ•ˆæœ

### å¹³æ¿ç«¯ (768px - 1024px)
- é”šå­—åŒºï¼š50% å®½åº¦
- å­—å¹•åŒºï¼š50% å®½åº¦
- ä¸­ç­‰åæœŸå¤„ç†æ•ˆæœ

### ç§»åŠ¨ç«¯ (â‰¤768px)
- çºµå‘å †å å¸ƒå±€
- é”šå­—åŒºåœ¨ä¸Šæ–¹
- å­—å¹•åŒºåœ¨ä¸‹æ–¹
- åŸºç¡€åæœŸå¤„ç†æ•ˆæœ

---

## ğŸ”§ å¼€å‘å·¥å…·å’Œè°ƒè¯•

### æ€§èƒ½ç›‘æ§é¢æ¿
```typescript
// src/components/debug/PerformancePanel.tsx
export function PerformancePanel() {
  const { fps, memory } = usePerformance()
  
  return (
    <div className="fixed top-4 right-4 bg-black/50 text-white p-2 rounded">
      <div>FPS: {fps}</div>
      <div>Memory: {memory}MB</div>
    </div>
  )
}
```

### æè´¨å‚æ•°è°ƒè¯•
```typescript
// src/components/debug/MaterialDebugger.tsx
export function MaterialDebugger() {
  const [fresnelPower, setFresnelPower] = useState(2.0)
  const [bloomIntensity, setBloomIntensity] = useState(0.5)
  
  return (
    <div className="fixed bottom-4 left-4 bg-black/50 text-white p-4 rounded">
      <div>
        <label>Fresnel Power: {fresnelPower}</label>
        <input 
          type="range" 
          min="0" 
          max="5" 
          step="0.1"
          value={fresnelPower}
          onChange={(e) => setFresnelPower(Number(e.target.value))}
        />
      </div>
      {/* æ›´å¤šè°ƒè¯•æ§ä»¶ */}
    </div>
  )
}
```

---

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### è§†è§‰æ•ˆæœéªŒæ”¶
- [ ] æ¨¡å‹å…·æœ‰æŸ”å’Œçš„è¾¹ç¼˜å‘å…‰æ•ˆæœ
- [ ] æ»šåŠ¨æ—¶æè´¨å‚æ•°åŠ¨æ€å˜åŒ–
- [ ] Bloom å…‰æ™•æ•ˆæœè‡ªç„¶
- [ ] é¢—ç²’è´¨æ„Ÿé€‚ä¸­ï¼Œä¸è¿‡åº¦
- [ ] æ¸å˜è‰²å½©è¿‡æ¸¡å¹³æ»‘

### æ€§èƒ½éªŒæ”¶
- [ ] æ¡Œé¢ç«¯ä¿æŒ 60fps
- [ ] ç§»åŠ¨ç«¯ä¿æŒ 45fps ä»¥ä¸Š
- [ ] å†…å­˜ä½¿ç”¨åˆç† (<200MB)
- [ ] åŠ è½½æ—¶é—´ <3ç§’

### äº¤äº’éªŒæ”¶
- [ ] æ»šåŠ¨å“åº”å»¶è¿Ÿ <100ms
- [ ] éŸ³é¢‘åŒæ­¥ç²¾åº¦ <200ms
- [ ] è§†è§‰æ•ˆæœä¸æ»šåŠ¨é€Ÿåº¦åŒ¹é…
- [ ] æ®µè½åˆ‡æ¢æ—¶çš„å‘¼å¸æ•ˆæœ

---

## ğŸ‰ é¢„æœŸæ•ˆæœ

å®ç°å®Œæˆåï¼ŒCoScroll å°†å‘ˆç°ï¼š

1. **ç©ºçµè´¨æ„Ÿ**ï¼šæ¨¡å‹å…·æœ‰æŸ”å’Œçš„å‘å…‰è¾¹ç¼˜ï¼Œä»¿ä½›ç”±å…‰çº¿æ„æˆ
2. **åŠ¨æ€å“åº”**ï¼šæ»šåŠ¨æ—¶æè´¨ã€å…‰ç…§ã€åæœŸæ•ˆæœå®æ—¶å˜åŒ–
3. **é¢—ç²’è´¨æ„Ÿ**ï¼šæ•´ä½“ç”»é¢å…·æœ‰èƒ¶ç‰‡é¢—ç²’æ„Ÿï¼Œå¢åŠ è‰ºæœ¯æ°›å›´
4. **è‰²å½©æ¸å˜**ï¼šä»ç²‰æ©™åˆ°é’è“çš„å¹³æ»‘è‰²å½©è¿‡æ¸¡
5. **æ€§èƒ½ç¨³å®š**ï¼šåœ¨å„ç§è®¾å¤‡ä¸Šéƒ½èƒ½æµç•…è¿è¡Œ

è¿™ä¸ªå®ç°æ–¹æ¡ˆå®Œå…¨åŸºäºæ‚¨ç°æœ‰çš„ MVP æ¶æ„ï¼Œåªéœ€è¦åœ¨ç°æœ‰ç»„ä»¶åŸºç¡€ä¸Šè¿›è¡Œå¢å¼ºï¼Œä¸ä¼šç ´åå·²æœ‰çš„åŠŸèƒ½ç»“æ„ã€‚

---

> **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šå»ºè®®ä»ç¬¬ä¸€é˜¶æ®µå¼€å§‹ï¼Œå…ˆä¸ºç°æœ‰çš„ `003_é“.glb` æ¨¡å‹æ·»åŠ åŸºç¡€æè´¨æ•ˆæœï¼ŒéªŒè¯æŠ€æœ¯å¯è¡Œæ€§åå†é€æ­¥æ·»åŠ åæœŸå¤„ç†æ•ˆæœã€‚

# 方案2故障排除指南

## 已修复问题

### ❌ Shader Context错误 (已解决)

**错误信息:**
```
Error: The shader being run is attached to a different context.
Do you need to copy it to this context first with .copyToContext()?
```

**原因:**
p5.js的Graphics对象(haloL0, haloL1等)拥有独立的WebGL context，无法直接使用主canvas的shader。

**解决方案:**
1. **模糊处理**: 从自定义shader改为使用p5内置的`filter(BLUR)`
2. **合成处理**: 从shader合成改为使用p5的`blendMode(ADD)`和`tint()`

**修改位置:**
- `sketch.ts:47-51` - 简化applyBlur函数
- `sketch.ts:188-208` - 使用p5原生blend模式

## 当前实现方式

### 1. 模糊金字塔

```typescript
// 使用p5内置filter
const applyBlur = (source: any, target: any, sigma: number) => {
  target.image(source, -target.width/2, -target.height/2, target.width, target.height);
  target.filter(p.BLUR, Math.floor(sigma));
};
```

**优势:**
- ✅ 无WebGL context冲突
- ✅ p5内置优化
- ✅ 跨平台兼容性好

**劣势:**
- ⚠️ 性能略低于自定义shader
- ⚠️ 模糊质量有限制

### 2. 合成系统

```typescript
// 使用ADD blend mode叠加模糊层
p.blendMode(p.ADD);
p.tint(255, 255, 255, 76);  // 30% alpha
p.image(haloL3, -p.width/2, -p.height/2, p.width, p.height);

// 最后叠加原始清晰层
p.blendMode(p.BLEND);
p.tint(255, 255, 255, 255);
p.image(haloL0, -p.width/2, -p.height/2, p.width, p.height);
```

**层级顺序 (从底到顶):**
1. L3 (最模糊) - 30% alpha
2. L2 (中等模糊) - 40% alpha
3. L1 (轻微模糊) - 30% alpha
4. L0 (原始清晰) - 100% alpha

## 访问测试

### 1. 启动服务器

```bash
npm run dev
```

### 2. 访问地址

服务器会自动选择可用端口:
- http://localhost:3000
- http://localhost:3001
- ...
- http://localhost:3005 (当前示例)

### 3. 预期效果

打开页面后应该看到:
- ✅ 彩色渐变背景
- ✅ "空"字3D模型缓慢旋转
- ✅ 柔软的光晕边缘
- ✅ 绿→橙→紫色渐变
- ✅ 呼吸式明暗变化

## 常见问题

### Q1: 页面空白，没有任何显示

**检查步骤:**

1. **打开浏览器控制台** (F12)
2. **查找错误信息:**
   ```
   [p5] Loading OBJ model: 001_空.obj
   [p5] Loading neon shader
   [p5] setup complete
   ```

3. **可能原因:**
   - OBJ文件未找到 → 检查 `/public/models/10k_obj/001_空.obj`
   - Shader文件未找到 → 检查 `/public/p5/shaders/neon.*`
   - p5.js未加载 → 检查 `node_modules/p5`

### Q2: 只有背景，没有3D模型

**检查步骤:**

1. **控制台查找:**
   ```
   [p5] Loading OBJ model: 001_空.obj
   ```
   如果没有此消息 → 模型加载失败

2. **可能原因:**
   - 文件路径错误
   - OBJ文件格式问题
   - 浏览器缓存问题

**解决方案:**
```bash
# 检查文件是否存在
ls -la public/models/10k_obj/001_空.obj

# 清理缓存并重启
rm -rf .next
npm run dev
```

### Q3: 模型显示但没有光晕效果

**检查shader加载:**

控制台应该显示:
```
[p5] Loading neon shader
```

**可能原因:**
- Shader文件路径错误
- Shader编译错误

**解决方案:**
```bash
# 确认shader文件存在
ls -la public/p5/shaders/neon.*

# 如果不存在，重新复制
cp src/p5/shaders/neon.* public/p5/shaders/
```

### Q4: 性能差，FPS低

**优化方案:**

1. **降低模糊强度** (`sketch.ts:170-176`)
   ```typescript
   applyBlur(haloL0, haloL1, 2.0); // 原4.0
   applyBlur(haloL1, haloL2, 3.0); // 原6.0
   applyBlur(haloL2, haloL3, 4.0); // 原8.0
   ```

2. **降低FBO分辨率** (`sketch.ts:84-87`)
   ```typescript
   haloL0 = p.createGraphics(p.width*0.75, p.height*0.75, p.WEBGL);
   ```

3. **减少模糊层数**
   只使用L0和L1，注释掉L2/L3的渲染和合成

### Q5: WebGL不支持错误

**错误信息:**
```
WebGL not supported
```

**解决方案:**
1. 更新浏览器到最新版本
2. 检查GPU驱动
3. 启用硬件加速 (Chrome设置 → 高级 → 系统)

### Q6: filter(BLUR)效果不明显

p5.js的`filter(BLUR)`有最大值限制。

**解决方案A**: 多次应用
```typescript
target.filter(p.BLUR, 5);
target.filter(p.BLUR, 5); // 应用两次
```

**解决方案B**: 增加alpha混合权重
```typescript
// 增加模糊层的透明度
p.tint(255, 255, 255, 120); // 从76增加到120
```

## 调试技巧

### 1. 查看FBO内容

在合成之前添加调试显示:
```typescript
// 临时显示各层效果
p.image(haloL0, -p.width/2, -p.height/2, p.width/4, p.height/4);
p.image(haloL1, -p.width/4, -p.height/2, p.width/4, p.height/4);
p.image(haloL2, 0, -p.height/2, p.width/4, p.height/4);
p.image(haloL3, p.width/4, -p.height/2, p.width/4, p.height/4);
```

### 2. 监控帧率

```typescript
if (p.frameCount % 60 === 0) {
  console.log('FPS:', Math.round(p.frameRate()));
}
```

### 3. 检查shader uniforms

```typescript
// 在shader.setUniform之后添加
console.log('uMainColor:', [0.3, 0.9, 0.5]);
console.log('uNoiseScale:', 2.0);
```

### 4. 临时禁用特效

逐步注释代码确定问题:
```typescript
// 1. 先只显示背景
// 注释掉OBJ渲染和合成部分

// 2. 然后只显示OBJ原始渲染
// 注释掉模糊和合成部分

// 3. 最后逐步启用完整流程
```

## 性能基准

| 配置 | FPS目标 | 说明 |
|-----|---------|------|
| 桌面端 (高配) | 60fps | 全分辨率，所有效果 |
| 桌面端 (中配) | 45-60fps | 0.8x分辨率，降低模糊 |
| 移动端 (新) | 30-45fps | 0.6x分辨率，2层模糊 |
| 移动端 (旧) | 20-30fps | 0.5x分辨率，仅1层模糊 |

## 进一步优化建议

如果当前性能仍不满意:

1. **方案2.5**: 预渲染静态光晕纹理
2. **方案1**: 升级到3D距离场纹理
3. **自适应**: 实现实时质量调整系统

---
**文档版本**: v1.1
**更新日期**: 2025-09-30
**最后测试**: localhost:3005 ✅
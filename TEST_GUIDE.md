# LyricSync 修复测试指南

## 测试环境准备

1. 启动开发服务器
   ```bash
   npm run dev
   ```

2. 打开浏览器访问 LyricSync 页面
   - 电脑端：使用 Chrome/Safari 浏览器
   - 手机端：使用移动设备浏览器

## 测试场景

### 场景1：初始化测试（修复歌词跳转问题）

#### 测试步骤
1. 刷新页面
2. 观察歌词列表的初始状态
3. 等待音频开始播放（可能需要点击播放按钮）

#### 预期结果
- ✅ 歌词从【观自在菩萨】开始显示（第一句）
- ✅ 大字显示区域显示"观"字
- ✅ 不应跳转到【舍利子】或其他句子

#### 失败表现（修复前）
- ❌ 歌词跳转到【舍利子】（第5句）
- ❌ 大字显示"舍"字
- ❌ 控制台可能有"🔧 初始化滚动位置"日志显示错误的索引

#### 检查要点
- 打开浏览器控制台，查找日志：
  ```
  🔧 初始化滚动位置 (使用实际DOM，强制索引0)
  ```
- `firstLyricOffset` 应该是第一句歌词的位置
- 不应看到使用其他索引的初始化日志

---

### 场景2：电脑端滚动测试（修复滚动阻尼问题）

#### 测试步骤
1. 音频开始播放后
2. 使用鼠标滚轮向下滚动歌词列表
3. 观察滚动的流畅度
4. 停止滚动，等待 1 秒

#### 预期结果
- ✅ 滚动流畅，无阻尼感
- ✅ 歌词可以自由上下滚动
- ✅ 停止后 1 秒，自动滚动从停止位置恢复
- ✅ 控制台显示"👆 用户开始滚动，暂停自动滚动 1000ms"

#### 失败表现（修复前）
- ❌ 滚轮滚动时有强大阻尼，根本滚不动
- ❌ 滚动位置被 RAF 循环覆盖
- ❌ 控制台显示"🚫 忽略程序滚动"

#### 检查要点
- 打开浏览器控制台，查找日志：
  ```
  👆 用户开始滚动，暂停自动滚动 1000ms
  ```
- 不应频繁看到"🚫 忽略程序滚动"日志
- 滚动时应该感觉自然流畅

---

### 场景3：手机端滚动测试（修复弹回问题）

#### 测试步骤
1. 使用手机打开页面
2. 音频开始播放后
3. 用手指向上滑动歌词列表
4. 快速滑动，让列表产生惯性滚动
5. 松开手指，观察滚动行为

#### 预期结果
- ✅ 滑动流畅，支持惯性滚动
- ✅ 松开手指后不会弹回原位
- ✅ 惯性滚动自然减速停止
- ✅ 停止后 1 秒，自动滚动从停止位置恢复

#### 失败表现（修复前）
- ❌ 能滚动，但手一松就弹回原位
- ❌ 惯性滚动被 RAF 循环打断
- ❌ 无法停留在用户选择的位置

#### 检查要点
- 使用 Safari 开发者工具（连接手机）查看控制台
- 应该看到"👆 用户开始滚动"日志
- 不应看到频繁的"🚫 忽略程序滚动"日志

---

### 场景4：音频同步测试（用户控制播放进度）

#### 测试步骤
1. 音频开始播放
2. 手动滚动到某句歌词，例如【度一切苦厄】（第4句）
3. 等待歌词居中对齐
4. 观察音频播放状态

#### 预期结果
- ✅ 音频跳转到对应时间（【度一切苦厄】= 36.79秒）
- ✅ 控制台显示"👆 用户手动滚动到歌词 { from: X, to: 3 }"
- ✅ 播放时间显示更新为 0:36 附近
- ✅ 1 秒后自动滚动从第4句继续

#### 失败表现（修复前）
- ❌ 音频不跳转，继续播放原位置
- ❌ 或者音频跳转了，但滚动立即被覆盖

#### 检查要点
- 控制台应该显示：
  ```
  👆 用户手动滚动到歌词 { from: 0, to: 3 }
  ```
- 音频的 `currentTime` 应该更新为 `36.79`
- `interpolatedTimeRef.current` 也应该同步更新

---

### 场景5：长时间播放测试（验证无跳转）

#### 测试步骤
1. 让音频自动播放完整首曲子（约 6 分钟）
2. 不进行任何手动操作
3. 观察歌词滚动是否流畅

#### 预期结果
- ✅ 歌词按顺序平滑滚动
- ✅ 不应有任何跳转或闪烁
- ✅ 每句歌词按时出现
- ✅ 控制台显示"🎵 RAF更新歌词索引"日志按顺序递增

#### 失败表现（修复前）
- ❌ 播放到 49.28 秒时跳转到【舍利子】
- ❌ 控制台显示多次"🔧 初始化滚动位置"

#### 检查要点
- 控制台应该只显示一次"🔧 初始化滚动位置"
- "🎵 RAF更新歌词索引"应该按 0→1→2→3... 顺序递增
- 不应看到索引突然跳跃（例如 0→4）

---

## 关键日志说明

### 正常日志（修复后）
```
🔧 初始化滚动位置 (使用实际DOM，强制索引0)
  firstLyricOffset: 128
  containerCenter: 400
  initialScrollTop: -272
✅ 自动播放成功，当前时间：0
🎵 RAF更新歌词索引 { audioTime: "11.85", interpolatedTime: "11.84", oldIndex: 0, newIndex: 0 }
👆 用户开始滚动，暂停自动滚动 1000ms
👆 用户手动滚动到歌词 { from: 0, to: 3 }
```

### 异常日志（修复前）
```
🔧 初始化滚动位置 (使用实际DOM) { currentLyricIndex: 4, ... }  ⚠️ 索引不是0
🚫 忽略程序滚动 { timeSince: 16.67 }  ⚠️ 频繁出现
🔧 初始化滚动位置 (使用实际DOM)  ⚠️ 多次初始化
```

---

## 性能指标

### 滚动响应延迟
- **目标**：< 100ms
- **测试**：从滚轮/触摸到页面滚动的延迟
- **预期**：几乎无延迟，流畅响应

### 自动滚动恢复时间
- **目标**：1000ms
- **测试**：停止手动滚动到自动滚动恢复的时间
- **预期**：1 秒后开始恢复

### 音频同步精度
- **目标**：< 200ms
- **测试**：手动滚动到歌词，到音频跳转的延迟
- **预期**：几乎立即跳转

---

## 故障排查

### 如果仍然跳转到【舍利子】
1. 检查 `isInitializedRef` 是否正确声明（第64行）
2. 检查初始化逻辑是否使用 `lyricRefs.current[0]`（第290行）
3. 查看控制台日志，确认只有一次初始化

### 如果仍然滚不动
1. 检查 `lastUserScrollTimeRef` 是否正确声明（第59行）
2. 检查 RAF 循环是否检查 `isUserScrolling`（第348行）
3. 查看控制台日志，确认"👆 用户开始滚动"出现

### 如果音频不同步
1. 检查 `handleScroll` 是否更新 `audio.currentTime`（第441行）
2. 检查是否同步 `interpolatedTimeRef.current`（第442行）
3. 检查是否同步 `currentScrollTopRef.current`（第443行）

---

## 回归测试清单

- [ ] 初始化从第一句开始
- [ ] 不跳转到其他句子
- [ ] 电脑端可流畅滚动
- [ ] 手机端不会弹回
- [ ] 用户滚动时自动滚动暂停
- [ ] 1 秒后自动滚动恢复
- [ ] 滚动到某句歌词，音频同步跳转
- [ ] 长时间播放无异常跳转
- [ ] 控制台无错误日志
- [ ] 性能指标符合预期

---

## 相关文档

- 详细分析：`/Users/aitoshuu/Documents/GitHub/CoScroll/BUG_ANALYSIS.md`
- 修复总结：`/Users/aitoshuu/Documents/GitHub/CoScroll/FIX_SUMMARY.md`
- 可视化指南：`/Users/aitoshuu/Documents/GitHub/CoScroll/VISUAL_FIX_GUIDE.md`
